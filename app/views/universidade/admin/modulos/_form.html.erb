<%= form_with model: modulo,
  url: modulo.new_record? ? admin_modulos_path : admin_modulo_path(modulo),
  data: { turbo_stream: true, action: "turbo:submit-end->modal#close turbo:submit-end->modal#reloadOnSuccess" },
  class: "space-y-5" do |f| %>

  <input type="hidden" name="from_curso_id" value="<%= local_assigns[:from_curso_id] %>">

  <% if modulo.errors.any? %>
    <%= alert_component(state: :danger, bordered: true) do |alert| %>
      <% alert.with_title { "#{modulo.errors.count} erro(s) impediram o salvamento:" } %>
      <% alert.with_body do %>
        <ul class="list-disc list-inside space-y-1 mt-1">
          <% modulo.errors.full_messages.each do |msg| %><li><%= msg %></li><% end %>
        </ul>
      <% end %>
    <% end %>
  <% end %>

  <%# Nome %>
  <div>
    <%= label_component(for: "modulo_nome") { "Nome *" } %>
    <%= input_field_component(
          type: "text", name: "modulo[nome]", id: "modulo_nome",
          value: modulo.nome, placeholder: "Ex: Fundamentos do Ruby",
          state: modulo.errors[:nome].any? ? :error : :default) %>
    <% if modulo.errors[:nome].any? %>
      <%= helper_text_component { modulo.errors[:nome].first } %>
    <% end %>
  </div>

  <%# Descrição %>
  <div>
    <%= label_component(for: "modulo_descricao") { "Descrição" } %>
    <%= text_area_component(
          name: "modulo[descricao]", id: "modulo_descricao",
          placeholder: "Uma breve descrição do módulo…", rows: 3) { modulo.descricao } %>
  </div>

  <%# Curso (opcional) %>
  <div>
    <%= label_component(for: "modulo_curso_id") { "Curso (opcional)" } %>
    <%
      curso_choices = { "Nenhum (módulo avulso)" => "" }.merge(
        @cursos.map { |c| [c.nome, c.id.to_s] }.to_h
      )
    %>
    <%= select_component(
          name: "modulo[curso_id]", id: "modulo_curso_id",
          choices: curso_choices,
          options: { selected: modulo.curso_id.to_s }) %>
  </div>

  <%# Visível %>
  <div>
    <input type="hidden" name="modulo[visivel]" value="0">
    <%= toggle_component(
          name: "modulo[visivel]", id: "modulo_visivel",
          checked: modulo.visivel?, checked_value: "1",
          color: :pink) { "Visível para os lojistas" } %>
  </div>

  <div class="flex items-center gap-3 pt-1">
    <input type="hidden" name="modulo[status_action]" id="modulo_status_action"
           value="<%= modulo.new_record? || modulo.rascunho? ? 'rascunho' : 'publicar' %>">
    
    <% if modulo.publicado? && !modulo.new_record? %>
      <%# Módulo já publicado: apenas botão Salvar alterações %>
      <button type="submit"
              onclick="document.getElementById('modulo_status_action').value='publicar'"
              class="px-4 py-2 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg transition-colors">
        Salvar alterações
      </button>
    <% else %>
      <%# Módulo em rascunho ou novo: botões Salvar rascunho e Publicar %>
      <button type="submit"
              onclick="document.getElementById('modulo_status_action').value='rascunho'"
              class="px-4 py-2 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg transition-colors">
        Salvar rascunho
      </button>
      <button type="submit"
              onclick="document.getElementById('modulo_status_action').value='publicar'"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
        Publicar
      </button>
    <% end %>
  </div>

<% end %>
